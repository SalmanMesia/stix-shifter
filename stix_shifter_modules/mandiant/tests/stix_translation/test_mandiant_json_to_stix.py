import json
import unittest
from functools import wraps
from stix_shifter_modules.mandiant.entry_point import EntryPoint

MODULE = "mandiant"
DATA_SOURCE = {"type": "identity", "id": "identity--3532c56d-ea72-48be-a2ad-1a53f4c9c6d3", "name": "Mandiant_Connector", "identity_class": "system"}
options = {'stix_validator':True}
entry_point = EntryPoint(options=options)
translation_options = {}
ip_value = "34.102.136.180"
extension_types = ['toplevel-property-extension']
extension_properties = ['x_ibm_original_threat_feed_data','threat_score']
query_pattern = "[ipv4-addr:value='"+ip_value+"']"
hash_value = '16cda323189d8eba4248c0a2f5ad0d8f'
hash_query_pattern = "[file:hashes.MD5='"+hash_value+"']"
url_value = "https://safaricom.co.ke"
url_query_pattern = "[url:value='"+url_value+"']"
domain_name = "telkom.co.id"
domain_query_pattern = "[domain-name:value='"+domain_name+"']"

transmitQueryData_ipv4 = {
    "data": [{'code': 200, 'data': '34.102.136.180', 'report': {'success': True, 'full': {'first_seen': '2020-06-02T23:00:11.000Z', 'last_seen': '2022-08-04T08:02:21.000Z', 'sources': [{'first_seen': '2020-08-14T23:34:01.314+0000', 'last_seen': '2021-10-27T23:34:14.796+0000', 'osint': True, 'category': ['exploit/vuln-scanning', 'exploit'], 'source_name': 'blocklist_net_ua'}, {'first_seen': '2020-11-06T22:10:01.936+0000', 'last_seen': '2022-05-21T00:10:00.709+0000', 'osint': True, 'category': ['phishing', 'malware'], 'source_name': 'phishstats'}, {'first_seen': '2021-02-13T22:05:01.791+0000', 'last_seen': '2021-02-13T22:05:01.791+0000', 'osint': True, 'category': [], 'source_name': 'stopforumspam'}, {'first_seen': '2020-07-23T18:02:13.939+0000', 'last_seen': '2022-08-04T08:02:21.859+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2020-11-10T20:00:02.556+0000', 'last_seen': '2020-11-28T20:00:03.098+0000', 'osint': True, 'category': ['exploit/vuln-scanning', 'exploit'], 'source_name': 'alienvault_reputation'}, {'first_seen': '2020-06-02T23:00:11.953+0000', 'last_seen': '2022-01-02T23:07:04.922+0000', 'osint': True, 'category': ['phishing'], 'source_name': 'phishtank'}], 'mscore': 50, 'verdict': {'mlVerdict': {'confidenceScore': 0.08254789664468065, 'modelVersion': '7.0.0', 'verdict': 'benign', 'reasoning': {'response_count': 7, 'benign_count': 3, 'neighbor_influence': 'benign', 'confidence_count': {'malicious': {'high': 0, 'low': 3, 'med': 1}, 'benign': {'high': 2, 'low': 1, 'med': 0}}, 'source_count': 112, 'malicious_count': 4, 'tp': {'tif': {'futex.re': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Futex.re', 'malicious_count': 0}, 'other': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Other', 'malicious_count': 0}, 'voipbl': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Voipbl', 'malicious_count': 0}, 'darklist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Darklist', 'malicious_count': 0}, 'greensnow': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Greensnow', 'malicious_count': 0}, 'dch': {'response_count': 1, 'benign_count': 1, 'source_count': 1, 'confidence': 'low', 'name': 'Dch', 'malicious_count': 0}, 'blocklist_net_ua': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Blocklist Net Ua', 'malicious_count': 0}, 'myip_blacklist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Myip Blacklist', 'malicious_count': 0}, 'turris_greylist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Turris Greylist', 'malicious_count': 0}, 'blocklist_de': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Blocklist De', 'malicious_count': 0}, 'projecthoneypot': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Projecthoneypot', 'malicious_count': 0}, 'cinsscore_ci_badguys': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Cinsscore Ci Badguys', 'malicious_count': 0}, 'emergingthreats_compromised_ips': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Emergingthreats Compromised Ips', 'malicious_count': 0}, 'digitalside_it_hashes': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Digitalside It Hashes', 'malicious_count': 0}, 'phishstats': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Phishstats', 'malicious_count': 0}, 'urlhaus': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Urlhaus', 'malicious_count': 0}, 'sblam_blacklist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Sblam Blacklist', 'malicious_count': 0}, 'cruz_it_blacklist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Cruz It Blacklist', 'malicious_count': 0}, 'abuse_ch_sslipbl_aggressive': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Abuse Ch Sslipbl Aggressive', 'malicious_count': 0}, 'viriback': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Viriback', 'malicious_count': 0}, 'xroxy': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Xroxy', 'malicious_count': 0}, 'malc0de': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malc0de', 'malicious_count': 0}, 'botscout': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Botscout', 'malicious_count': 0}, 'rutgers_drop': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Rutgers Drop', 'malicious_count': 0}, 'spamhaus_edrop': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Spamhaus Edrop', 'malicious_count': 0}, 'spamhaus_drop': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Spamhaus Drop', 'malicious_count': 0}, 'digitalside_it_ips': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Digitalside It Ips', 'malicious_count': 0}, 'urlvir': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Urlvir', 'malicious_count': 0}, 'the_haleys_ssh_dict_attack': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'The Haleys Ssh Dict Attack', 'malicious_count': 0}, 'cybercrimetracker_fuckers': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Cybercrimetracker', 'malicious_count': 0}, 'rulez_blist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Rulez Blist', 'malicious_count': 0}, 'azorult-tracker': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Azorult-tracker', 'malicious_count': 0}, 'phishtank': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Phishtank', 'malicious_count': 0}, 'name': 'Threat Intelligence Feeds', 'abuse_ch_sslipbl': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Abuse Ch Sslipbl', 'malicious_count': 0}}, 'crowdsource': {'response_count': 3, 'benign_count': 0, 'source_count': 46, 'confidence': 'low', 'name': 'Crowdsourced Threat Analysis', 'malicious_count': 3}, 'tor': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Tor Nodes', 'malicious_count': 0}, 'name': 'Third Party', 'misp': {'other': {'response_count': 0, 'benign_count': 0, 'source_count': 2, 'confidence': None, 'name': 'Other', 'malicious_count': 0}, 'vpn': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Known VPN Hosting Provider', 'malicious_count': 0}, 'name': 'MISP', 'dch': {'response_count': 1, 'benign_count': 1, 'source_count': 6, 'confidence': 'high', 'name': 'Dynamic Cloud Hosting (DCH) Provider', 'malicious_count': 0}, 'sinkhole': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Internet Sinkhole', 'malicious_count': 0}, 'popular_infra': {'response_count': 0, 'benign_count': 0, 'source_count': 12, 'confidence': None, 'name': 'Popular Internet Infrastructure', 'malicious_count': 0}}, 'greynoise': {'name': 'GreyNoise', 'context': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Context', 'malicious_count': 0}, 'riot': {'response_count': 0, 'benign_count': 0, 'source_count': 2, 'confidence': None, 'name': 'RIOT', 'malicious_count': 0}}}, 'mandiant': {'bp_hosting': {'response_count': 0, 'benign_count': 0, 'source_count': 2, 'confidence': None, 'name': 'Bulletproof Hosting', 'malicious_count': 0}, 'name': 'Mandiant', 'malware_analysis': {'response_count': 1, 'benign_count': 0, 'source_count': 2, 'confidence': 'med', 'name': 'Malware Analysis', 'malicious_count': 1}, 'knowledge_graph': {'response_count': 1, 'benign_count': 1, 'source_count': 2, 'confidence': 'high', 'name': 'Knowledge Graph', 'malicious_count': 0}}, 'version': '1.0.2'}, 'timestamp': '2022-08-04T08:24:35.617+0000'}, 'analystVerdict': {'confidenceScore': 50, 'verdict': 'unknown', 'reasoning': {'malicious': {'nucleus': ['sig:detect']}, 'benign': {'nucleus': ['omit:parkip']}}, 'timestamp': '2022-08-04T08:02:23.914+0000'}, 'authoritativeVerdict': 'analystVerdict'}, 'misp': {'smtp-receiving-ips': False, 'covid': False, 'eicar.com': False, 'majestic_million': False, 'sinkholes': False, 'alexa': False, 'cisco_top1000': False, 'microsoft': False, 'microsoft-office365': False, 'crl-hostname': False, 'googlebot': False, 'microsoft-azure-germany': False, 'microsoft-attack-simulator': False, 'microsoft-azure': False, 'rfc5735': False, 'tranco10k': False, 'dax30': False, 'public-dns-v4': False, 'dynamic-dns': False, 'public-dns-v6': False, 'covid-19-cyber-threat-coalition-whitelist': False, 'common-ioc-false-positive': False, 'cisco_1M': False, 'google-gmail-sending-ips': False, 'microsoft-azure-china': False, 'stackpath': False, 'google': False, 'cloudflare': False, 'moz-top500': False, 'tranco': False, 'tlds': False, 'university_domains': False, 'smtp-sending-ips': False, 'cisco_top20k': False, 'empty-hashes': False, 'nioc-filehash': False, 'amazon-aws': False, 'url-shortener': False, 'microsoft-office365-ip': False, 'microsoft-win10-connection-endpoints': False, 'microsoft-azure-us-gov': False, 'majestic_million_1M': False, 'mozilla-CA': False, 'whats-my-ip': False, 'microsoft-office365-cn': False, 'vpn-ipv6': False, 'rfc3849': False, 'rfc6761': False, 'security-provider-blogpost': False, 'cisco_top5k': False, 'apple': False, 'public-dns-hostname': False, 'mozilla-IntermediateCA': False, 'rfc1918': False, 'ti-falsepositives': False, 'akamai': False, 'bank-website': False, 'alexa_1M': False, 'automated-malware-analysis': False, 'rfc6598': False, 'google-gcp': True, 'ovh-cluster': False, 'multicast': False, 'phone_numbers': False, 'fastly': False, 'cisco_top10k': False, 'second-level-tlds': False, 'wikimedia': False, 'disposable-email': False, 'common-contact-emails': False, 'vpn-ipv4': False, 'ipv6-linklocal': False, 'covid-19-krassi-whitelist': False, 'crl-ip': False}, 'id': 'ipv4--a18762d7-7a11-5fbc-8011-d503f8e46c7d', 'type': 'ipv4', 'value': '34.102.136.180', 'is_publishable': True, 'last_updated': '2022-08-04T08:26:33.431Z'}}, 'dataType': 'ip', 'external_reference': {'source_name': 'Mandiant_Connector', 'url': 'N/A'}, 'namespace': '8bf42ea1-e30d-41a2-a3ee-1aec759cf409'}]
}

transmitQueryData_domain = {
    "data": [{'code': 200, 'data': 'google.com', 'report': {'success': True, 'full': {'first_seen': '2014-09-01T21:39:23.000Z', 'last_seen': '2022-07-31T18:43:36.000Z', 'sources': [{'first_seen': '2021-07-02T15:17:26.283+0000', 'last_seen': '2021-08-06T19:18:00.231+0000', 'osint': False, 'category': ['control-server', 'botnet'], 'source_name': 'Mandiant'}, {'first_seen': '2014-09-01T21:39:23.000+0000', 'last_seen': '2018-09-05T14:26:02.000+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2020-01-30T15:49:31.326+0000', 'last_seen': '2020-01-30T15:49:31.326+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-09-23T23:02:11.244+0000', 'last_seen': '2021-10-10T22:40:25.469+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-12-14T00:19:22.164+0000', 'last_seen': '2021-12-16T18:37:17.664+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2020-02-16T16:12:57.000+0000', 'last_seen': '2021-12-04T00:12:41.000+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2020-02-29T04:38:11.915+0000', 'last_seen': '2020-04-16T10:17:05.796+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-12-14T04:32:32.348+0000', 'last_seen': '2022-07-31T18:43:36.320+0000', 'osint': True, 'category': [], 'source_name': 'dtm.blackbeard'}, {'first_seen': '2021-06-24T23:25:00.803+0000', 'last_seen': '2021-06-24T23:25:00.803+0000', 'osint': True, 'category': [], 'source_name': 'futex.re'}, {'first_seen': '2021-09-22T17:49:34.000+0000', 'last_seen': '2021-09-22T17:49:34.000+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-12-14T21:07:25.784+0000', 'last_seen': '2022-07-18T13:30:13.212+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-09-23T23:00:39.636+0000', 'last_seen': '2021-09-24T23:01:22.370+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2020-08-30T15:42:25.470+0000', 'last_seen': '2020-08-30T15:42:25.470+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-06-18T04:31:40.390+0000', 'last_seen': '2022-07-08T13:31:08.935+0000', 'osint': False, 'category': ['control-server', 'banker'], 'source_name': 'Mandiant'}, {'first_seen': '2021-12-13T23:51:44.068+0000', 'last_seen': '2021-12-16T20:38:38.965+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}], 'mscore': 0, 'attributed_associations': [{'id': 'threat-actor--0b71bacd-7e68-53ef-8012-e31ae03359fd', 'name': 'UNC1147', 'type': 'threat-actor'}], 'verdict': {'mlVerdict': {'confidenceScore': 0.00036319229440634536, 'modelVersion': '7.0.0', 'verdict': 'benign', 'reasoning': {'response_count': 5, 'benign_count': 4, 'neighbor_influence': 'malicious', 'confidence_count': {'malicious': {'high': 0, 'low': 1, 'med': 0}, 'benign': {'high': 3, 'low': 1, 'med': 0}}, 'source_count': 102, 'malicious_count': 1, 'mandiant': {'name': 'Mandiant', 'malware_analysis': {'response_count': 0, 'benign_count': 0, 'source_count': 2, 'confidence': None, 'name': 'Malware Analysis', 'malicious_count': 0}, 'knowledge_graph': {'response_count': 1, 'benign_count': 1, 'source_count': 2, 'confidence': 'high', 'name': 'Knowledge Graph', 'malicious_count': 0}, 'spam': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Spam Monitoring', 'malicious_count': 0}, 'fqdn_analysis': {'response_count': 1, 'benign_count': 1, 'source_count': 2, 'confidence': 'low', 'name': 'FQDN Analysis', 'malicious_count': 0}}, 'tp': {'tif': {'digitalside_it_hashes': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Digitalside It Hashes', 'malicious_count': 0}, 'joewein_domains': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Joewein Domains', 'malicious_count': 0}, 'other': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Other', 'malicious_count': 0}, 'urlhaus': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Urlhaus', 'malicious_count': 0}, 'azorult-tracker': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Azorult-tracker', 'malicious_count': 0}, 'digitalside_it_domains': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Digitalside It Domains', 'malicious_count': 0}, 'phishtank': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Phishtank', 'malicious_count': 0}, 'viriback': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Viriback', 'malicious_count': 0}, 'created': {'response_count': 0, 'benign_count': 0, 'source_count': 2, 'confidence': None, 'name': 'Created', 'malicious_count': 0}, 'name': 'Threat Intelligence Feeds', 'malc0de': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malc0de', 'malicious_count': 0}, 'tds_harvester': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Tds Harvester', 'malicious_count': 0}}, 'crowdsource': {'response_count': 1, 'benign_count': 0, 'source_count': 55, 'confidence': 'low', 'name': 'Crowdsourced Threat Analysis', 'malicious_count': 1}, 'name': 'Third Party', 'misp': {'other': {'response_count': 0, 'benign_count': 0, 'source_count': 10, 'confidence': None, 'name': 'Other', 'malicious_count': 0}, 'popular_web': {'response_count': 1, 'benign_count': 1, 'source_count': 8, 'confidence': 'high', 'name': 'Popular Website', 'malicious_count': 0}, 'edu': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Educational Institution', 'malicious_count': 0}, 'name': 'MISP', 'dch': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Dynamic Cloud Hosting (DCH) Provider', 'malicious_count': 0}, 'popular_infra': {'response_count': 1, 'benign_count': 1, 'source_count': 8, 'confidence': 'high', 'name': 'Popular Internet Infrastructure', 'malicious_count': 0}}}, 'version': '1.0.2'}, 'timestamp': '2022-08-04T00:07:07.803+0000'}, 'analystVerdict': {'confidenceScore': 0, 'verdict': 'benign', 'reasoning': {'benign': {'nucleus': ['omit:legit.google']}}, 'timestamp': '2022-08-04T00:03:21.537+0000'}, 'authoritativeVerdict': 'analystVerdict'}, 'misp': {'smtp-receiving-ips': False, 'covid': False, 'eicar.com': False, 'majestic_million': True, 'sinkholes': False, 'alexa': True, 'cisco_top1000': True, 'microsoft': False, 'microsoft-office365': False, 'crl-hostname': False, 'googlebot': False, 'microsoft-azure-germany': False, 'microsoft-attack-simulator': False, 'microsoft-azure': False, 'rfc5735': False, 'tranco10k': True, 'dax30': False, 'public-dns-v4': False, 'dynamic-dns': False, 'public-dns-v6': False, 'covid-19-cyber-threat-coalition-whitelist': False, 'common-ioc-false-positive': False, 'cisco_1M': True, 'google-gmail-sending-ips': False, 'microsoft-azure-china': False, 'stackpath': False, 'google': True, 'cloudflare': False, 'moz-top500': False, 'tranco': True, 'tlds': True, 'university_domains': False, 'smtp-sending-ips': False, 'cisco_top20k': True, 'empty-hashes': False, 'nioc-filehash': False, 'amazon-aws': False, 'url-shortener': False, 'microsoft-office365-ip': False, 'microsoft-win10-connection-endpoints': False, 'microsoft-azure-us-gov': False, 'majestic_million_1M': True, 'mozilla-CA': False, 'whats-my-ip': False, 'microsoft-office365-cn': False, 'vpn-ipv6': False, 'rfc3849': False, 'rfc6761': False, 'security-provider-blogpost': False, 'cisco_top5k': True, 'apple': False, 'public-dns-hostname': False, 'mozilla-IntermediateCA': False, 'rfc1918': False, 'ti-falsepositives': False, 'akamai': False, 'bank-website': False, 'alexa_1M': True, 'automated-malware-analysis': False, 'rfc6598': False, 'google-gcp': False, 'ovh-cluster': False, 'multicast': False, 'phone_numbers': False, 'fastly': False, 'cisco_top10k': True, 'second-level-tlds': True, 'wikimedia': False, 'disposable-email': False, 'common-contact-emails': False, 'vpn-ipv4': False, 'ipv6-linklocal': False, 'covid-19-krassi-whitelist': False, 'crl-ip': False}, 'id': 'fqdn--7baea406-cc1b-53f9-b1b2-ea4ad2f56dc1', 'type': 'fqdn', 'value': 'google.com', 'is_publishable': True, 'last_updated': '2022-08-04T00:07:12.277Z'}}, 'dataType': 'domain', 'external_reference': {'source_name': 'Mandiant_Connector', 'url': 'N/A'}, 'namespace': '8bf42ea1-e30d-41a2-a3ee-1aec759cf409'}]
}

transmitQueryData_url = {
    "data": [{'code': 200, 'data': 'http://www.google.com', 'report': {'success': True, 'full': {'first_seen': '2021-06-19T08:10:07.000Z', 'last_seen': '2022-07-20T16:18:41.000Z', 'sources': [{'first_seen': '2022-06-20T12:51:55.045+0000', 'last_seen': '2022-07-20T16:18:41.651+0000', 'osint': True, 'category': [], 'source_name': 'dtm.blackbeard'}, {'first_seen': '2022-03-13T19:05:57.000+0000', 'last_seen': '2022-03-13T19:05:57.000+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-08-11T08:18:13.000+0000', 'last_seen': '2021-11-09T04:23:07.000+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2021-12-14T07:10:27.468+0000', 'last_seen': '2021-12-16T00:15:31.250+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}], 'mscore': 0, 'verdict': {'mlVerdict': {'confidenceScore': 0.0014256951301307784, 'modelVersion': '6.2.0', 'verdict': 'benign', 'reasoning': {'response_count': 5, 'benign_count': 5, 'neighbor_influence': None, 'confidence_count': {'malicious': {'high': 0, 'low': 0, 'med': 0}, 'benign': {'high': 1, 'low': 1, 'med': 3}}, 'source_count': 185, 'malicious_count': 0, 'mandiant': {'bp_hosting': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Bulletproof Hosting', 'malicious_count': 0}, 'url_analysis': {'response_count': 2, 'benign_count': 2, 'source_count': 4, 'confidence': 'low', 'name': 'URL Analysis', 'malicious_count': 0}, 'name': 'Mandiant', 'malware_analysis': {'response_count': 0, 'benign_count': 0, 'source_count': 3, 'confidence': None, 'name': 'Malware Analysis', 'malicious_count': 0}, 'knowledge_graph': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Knowledge Graph', 'malicious_count': 0}, 'spam': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Spam Monitoring', 'malicious_count': 0}, 'fqdn_analysis': {'response_count': 0, 'benign_count': 0, 'source_count': 2, 'confidence': None, 'name': 'FQDN Analysis', 'malicious_count': 0}}, 'tp': {'tif': {'futex.re': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Futex.re', 'malicious_count': 0}, 'feodo_ids': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Feodo Ids', 'malicious_count': 0}, 'h3x_1day': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'H3x 1day', 'malicious_count': 0}, 'malwared': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malwared', 'malicious_count': 0}, 'digitalside_it_urls': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Digitalside It Urls', 'malicious_count': 0}, 'malwaremustdie': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malwaremustdie', 'malicious_count': 0}, 'malwaredomainlist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malwaredomainlist', 'malicious_count': 0}, 'dev': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Dev', 'malicious_count': 0}, 'phishing_database': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Phishing Database', 'malicious_count': 0}, 'benkow': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Benkow', 'malicious_count': 0}, 'urlscan_phishing': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Urlscan Phishing', 'malicious_count': 0}, 'feodo': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Feodo', 'malicious_count': 0}, 'botvrij_urls': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Botvrij Urls', 'malicious_count': 0}, 'dyndns_ponmocup': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Dyndns Ponmocup', 'malicious_count': 0}, 'cybercrimetracker': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Cybercrimetracker', 'malicious_count': 0}, 'digitalside_it_hashes': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Digitalside It Hashes', 'malicious_count': 0}, 'phishstats': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Phishstats', 'malicious_count': 0}, 'fumik0': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Fumik0', 'malicious_count': 0}, 'urlhaus': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Urlhaus', 'malicious_count': 0}, 'cryptolaemus': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Cryptolaemus', 'malicious_count': 0}, 'viriback': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Viriback', 'malicious_count': 0}, 'openphish': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Openphish', 'malicious_count': 0}, 'malc0de': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malc0de', 'malicious_count': 0}, 'malshare': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malshare', 'malicious_count': 0}, 'davidonzo_hashes': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Davidonzo Hashes', 'malicious_count': 0}, 'azorult-tracker': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Azorult-tracker', 'malicious_count': 0}, 'phishtank': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Phishtank', 'malicious_count': 0}, 'phishtank_valid_online': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Phishtank Valid Online', 'malicious_count': 0}, 'name': 'Threat Intelligence Feeds', 'vxvault_virilist': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Vxvault Virilist', 'malicious_count': 0}, 'aa419': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Aa419', 'malicious_count': 0}}, 'crowdsource': {'response_count': 0, 'benign_count': 0, 'source_count': 91, 'confidence': None, 'name': 'Crowdsourced Threat Analysis', 'malicious_count': 0}, 'name': 'Third Party', 'misp': {'other': {'response_count': 0, 'benign_count': 0, 'source_count': 14, 'confidence': None, 'name': 'Other', 'malicious_count': 0}, 'popular_web': {'response_count': 2, 'benign_count': 2, 'source_count': 8, 'confidence': 'med', 'name': 'Popular Website', 'malicious_count': 0}, 'vpn': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Known VPN Hosting Provider', 'malicious_count': 0}, 'edu': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Educational Institution', 'malicious_count': 0}, 'name': 'MISP', 'dch': {'response_count': 0, 'benign_count': 0, 'source_count': 9, 'confidence': None, 'name': 'Dynamic Cloud Hosting (DCH) Provider', 'malicious_count': 0}, 'sinkhole': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Internet Sinkhole', 'malicious_count': 0}, 'popular_infra': {'response_count': 1, 'benign_count': 1, 'source_count': 18, 'confidence': 'med', 'name': 'Popular Internet Infrastructure', 'malicious_count': 0}}}, 'version': '1.0.2'}, 'timestamp': '2022-07-20T16:19:07.882+0000'}, 'analystVerdict': {'confidenceScore': 0, 'verdict': None, 'timestamp': None}, 'authoritativeVerdict': 'mlVerdict'}, 'misp': {'smtp-receiving-ips': False, 'covid': False, 'eicar.com': False, 'majestic_million': True, 'sinkholes': False, 'alexa': True, 'cisco_top1000': True, 'microsoft': False, 'microsoft-office365': False, 'crl-hostname': False, 'googlebot': False, 'microsoft-azure-germany': False, 'microsoft-attack-simulator': False, 'microsoft-azure': False, 'rfc5735': False, 'tranco10k': True, 'dax30': False, 'public-dns-v4': False, 'dynamic-dns': False, 'public-dns-v6': False, 'covid-19-cyber-threat-coalition-whitelist': False, 'common-ioc-false-positive': False, 'cisco_1M': True, 'google-gmail-sending-ips': False, 'microsoft-azure-china': False, 'stackpath': False, 'google': True, 'cloudflare': False, 'moz-top500': True, 'tranco': True, 'tlds': True, 'university_domains': False, 'smtp-sending-ips': False, 'cisco_top20k': True, 'empty-hashes': False, 'nioc-filehash': False, 'amazon-aws': False, 'url-shortener': False, 'microsoft-office365-ip': False, 'microsoft-win10-connection-endpoints': False, 'microsoft-azure-us-gov': False, 'majestic_million_1M': True, 'mozilla-CA': False, 'whats-my-ip': False, 'microsoft-office365-cn': False, 'vpn-ipv6': False, 'rfc3849': False, 'rfc6761': False, 'security-provider-blogpost': True, 'cisco_top5k': True, 'apple': False, 'public-dns-hostname': False, 'mozilla-IntermediateCA': False, 'rfc1918': False, 'ti-falsepositives': False, 'akamai': False, 'bank-website': False, 'alexa_1M': True, 'automated-malware-analysis': False, 'rfc6598': False, 'google-gcp': False, 'ovh-cluster': False, 'multicast': False, 'phone_numbers': False, 'fastly': False, 'cisco_top10k': True, 'second-level-tlds': True, 'wikimedia': False, 'disposable-email': False, 'common-contact-emails': False, 'vpn-ipv4': False, 'ipv6-linklocal': False, 'covid-19-krassi-whitelist': False, 'crl-ip': False}, 'id': 'url--a9b1c98a-4db2-5098-b979-68b441141494', 'type': 'url', 'value': 'http://www.google.com', 'is_publishable': True, 'last_updated': '2022-07-20T16:19:09.792Z'}}, 'dataType': 'url', 'external_reference': {'source_name': 'Mandiant_Connector', 'url': 'N/A'}, 'namespace': '8bf42ea1-e30d-41a2-a3ee-1aec759cf409'}]
}

transmitQueryData_md5 = {
    "data": [{'code': 200, 'data': 'b8a7b71bfbde9901d20ab179e4dead58', 'report': {'success': True, 'full': {'first_seen': '2017-05-13T00:35:11.000Z', 'last_seen': '2017-08-28T04:12:44.000Z', 'sources': [{'first_seen': '2017-05-13T00:35:11.000+0000', 'last_seen': '2017-08-28T04:12:44.000+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}, {'first_seen': '2017-05-13T00:35:11.000+0000', 'last_seen': '2017-05-13T00:35:11.000+0000', 'osint': False, 'category': [], 'source_name': 'Mandiant'}], 'associated_hashes': [{'id': 'md5--136f3c37-bfa6-5446-bb2c-eaf272e9d07c', 'type': 'md5', 'value': 'b8a7b71bfbde9901d20ab179e4dead58'}, {'id': 'sha1--947d0f7f-29a5-549d-a656-53a1226303eb', 'type': 'sha1', 'value': 'eea7386f7b938c6785cf14221ad3f00516d271db'}, {'id': 'sha256--0f5c1d60-2db6-5628-be8e-05317d7cb01c', 'type': 'sha256', 'value': '31c2024d0df684a968115e4c3fc5703ef0ea2de1b69ece581589e86ba084568a'}], 'mscore': 100, 'verdict': {'analystVerdict': {'confidenceScore': 100, 'verdict': 'malicious', 'reasoning': {'malicious': {'nucleus': ['sig:mal']}}, 'timestamp': '2022-02-20T22:23:45.107+0000'}, 'mlVerdict': {'confidenceScore': 0.9909393001380892, 'modelVersion': '6.2.0', 'verdict': 'malicious', 'reasoning': {'response_count': 2, 'neighbor_influence': None, 'benign_count': 0, 'confidence_count': {'malicious': {'high': 2, 'low': 0, 'med': 0}, 'benign': {'high': 0, 'low': 0, 'med': 0}}, 'source_count': 108, 'malicious_count': 2, 'mandiant': {'malware_analysis': {'response_count': 1, 'benign_count': 0, 'source_count': 4, 'confidence': 'high', 'name': 'Malware Analysis', 'malicious_count': 1}, 'name': 'Mandiant', 'knowledge_graph': {'response_count': 1, 'benign_count': 0, 'source_count': 1, 'confidence': 'high', 'name': 'Knowledge Graph', 'malicious_count': 1}, 'spam': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Spam Monitoring', 'malicious_count': 0}}, 'tp': {'tif': {'digitalside_it_hashes': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Digitalside It Hashes', 'malicious_count': 0}, 'futex.re': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Futex.re', 'malicious_count': 0}, 'urlhaus': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Urlhaus', 'malicious_count': 0}, 'fumik0': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Fumik0', 'malicious_count': 0}, 'davidonzo_hashes': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Davidonzo Hashes', 'malicious_count': 0}, 'name': 'Threat Intelligence Feeds', 'malc0de': {'response_count': 0, 'benign_count': 0, 'source_count': 1, 'confidence': None, 'name': 'Malc0de', 'malicious_count': 0}}, 'crowdsource': {'response_count': 0, 'benign_count': 0, 'source_count': 93, 'confidence': None, 'name': 'Crowdsourced Threat Analysis', 'malicious_count': 0}, 'name': 'Third Party', 'misp': {'trusted_software': {'response_count': 0, 'benign_count': 0, 'source_count': 3, 'confidence': None, 'name': 'Trusted Software List', 'malicious_count': 0}, 'name': 'MISP'}}, 'version': '1.0.2'}, 'timestamp': '2022-02-20T22:23:45.194+0000'}, 'authoritativeVerdict': 'analystVerdict'}, 'misp': {'smtp-receiving-ips': False, 'covid': False, 'eicar.com': False, 'majestic_million': False, 'sinkholes': False, 'alexa': False, 'cisco_top1000': False, 'crl-hostname': False, 'microsoft-office365': False, 'microsoft': False, 'googlebot': False, 'microsoft-azure-germany': False, 'microsoft-attack-simulator': False, 'microsoft-azure': False, 'rfc5735': False, 'tranco10k': False, 'public-dns-v4': False, 'dax30': False, 'dynamic-dns': False, 'public-dns-v6': False, 'covid-19-cyber-threat-coalition-whitelist': False, 'common-ioc-false-positive': False, 'cisco_1M': False, 'google-gmail-sending-ips': False, 'microsoft-azure-china': False, 'stackpath': False, 'google': False, 'cloudflare': False, 'moz-top500': False, 'tranco': False, 'tlds': False, 'university_domains': False, 'smtp-sending-ips': False, 'cisco_top20k': False, 'empty-hashes': False, 'nioc-filehash': False, 'amazon-aws': False, 'url-shortener': False, 'microsoft-office365-ip': False, 'microsoft-win10-connection-endpoints': False, 'microsoft-azure-us-gov': False, 'majestic_million_1M': False, 'mozilla-CA': False, 'whats-my-ip': False, 'microsoft-office365-cn': False, 'vpn-ipv6': False, 'rfc3849': False, 'rfc6761': False, 'security-provider-blogpost': False, 'cisco_top5k': False, 'apple': False, 'public-dns-hostname': False, 'mozilla-IntermediateCA': False, 'rfc1918': False, 'ti-falsepositives': False, 'akamai': False, 'bank-website': False, 'automated-malware-analysis': False, 'rfc6598': False, 'alexa_1M': False, 'google-gcp': False, 'ovh-cluster': False, 'multicast': False, 'phone_numbers': False, 'fastly': False, 'cisco_top10k': False, 'second-level-tlds': False, 'wikimedia': False, 'disposable-email': False, 'common-contact-emails': False, 'vpn-ipv4': False, 'ipv6-linklocal': False, 'covid-19-krassi-whitelist': False, 'crl-ip': False}, 'id': 'md5--136f3c37-bfa6-5446-bb2c-eaf272e9d07c', 'type': 'md5', 'value': 'b8a7b71bfbde9901d20ab179e4dead58', 'is_publishable': True, 'last_updated': '2022-02-21T00:37:58.556Z'}}, 'dataType': 'hash', 'external_reference': {'source_name': 'Mandiant_Connector', 'url': 'N/A'}, 'namespace': '8bf42ea1-e30d-41a2-a3ee-1aec759cf409'}]
}

transmitQueryData_md5_notfound = {
    "data": [{'code': 200, 'data': 'dccbda7c9ad6201ccb088078765e035d', 'report': {'success': 'True', 'full': {'error': 'The request resource is not found! The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.'}}, 'dataType': 'hash', 'external_reference': {'source_name': 'Mandiant_Connector', 'url': 'N/A'}, 'namespace': '8bf42ea1-e30d-41a2-a3ee-1aec759cf409'}]
}

class TestMandiantResultsToStix(unittest.TestCase):
    """
    class to perform unit test case for mandiant translate results
    """

    def __init__(self,*args, **kwargs):
        super(TestMandiantResultsToStix, self).__init__(*args, **kwargs)
        self.result_translator = entry_point.create_default_results_translator(dialect='default')
        self.extension_property_names = []
    
    @staticmethod
    def exists(obj, chain):
        """
        Check if the nested keys exist in the dictionary or not
        """
        _key = chain.pop(0)
        if _key in obj:
            return TestMandiantResultsToStix.exists(obj[_key], chain) if chain else obj[_key]
    
    @staticmethod
    def get_first(itr, constraint):
        return next(
            (obj for obj in itr if constraint(obj)),
            None
        )

    @staticmethod
    def get_first_of_type(itr, typ):
        return TestMandiantResultsToStix.get_first(itr, lambda o: type(o) == dict and o.get('type') == typ)
            
    def get_extension_property_keys(self, obj):
        for k, v in obj.items():
            if isinstance(v,dict) and not "key" in v:
                self.get_extension_property_keys(v)
            else:
                self.extension_property_names.append(v["key"])
        return self.extension_property_names
    

    def convert_bundle_object(transmit_data):
        def decorator(func):
            def wrapper_func(self, *args, **kwargs):
                self.result_bundle = self.result_translator.translate_results(data_source=DATA_SOURCE, data=transmit_data['data'])
                self.result_bundle_objects = self.result_bundle['objects']
                func(self)
            return wrapper_func
        return decorator

    @convert_bundle_object(transmitQueryData_ipv4)
    def test_query_ipv4(self):
        sdo_type_identity = "identity"
        stix_identity = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_identity)
        assert 'type' in stix_identity and stix_identity['type'] == DATA_SOURCE['type']
        assert 'name' in stix_identity and stix_identity['name'] == DATA_SOURCE['name']
        assert 'identity_class' in stix_identity and stix_identity['identity_class'] == DATA_SOURCE['identity_class']
        
        sdo_type_extenseion = 'extension-definition'
        stix_extension = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, 'extension-definition')
        assert 'type' in stix_extension and stix_extension['type'] == sdo_type_extenseion
        assert 'name' in stix_extension
        assert 'version' in stix_extension
        assert 'extension_types' in stix_extension and stix_extension['extension_types'] == extension_types
        assert 'extension_properties' in stix_extension and 'threat_attributes' in stix_extension['extension_properties']

        sdo_type_indicator = "indicator"
        stix_indicator = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_indicator)
        assert 'x_ibm_original_threat_feed_data' in stix_indicator
        assert 'full' in stix_indicator['x_ibm_original_threat_feed_data']
        assert 'description' in stix_indicator

    @convert_bundle_object(transmitQueryData_domain)
    def test_query_domain(self):
        sdo_type_identity = "identity"
        stix_identity = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_identity)
        assert 'type' in stix_identity and stix_identity['type'] == DATA_SOURCE['type']
        assert 'name' in stix_identity and stix_identity['name'] == DATA_SOURCE['name']
        assert 'identity_class' in stix_identity and stix_identity['identity_class'] == DATA_SOURCE['identity_class']
        
        sdo_type_extenseion = 'extension-definition'
        stix_extension = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, 'extension-definition')
        assert 'type' in stix_extension and stix_extension['type'] == sdo_type_extenseion
        assert 'name' in stix_extension
        assert 'version' in stix_extension
        assert 'extension_types' in stix_extension and stix_extension['extension_types'] == extension_types
        assert 'extension_properties' in stix_extension and 'threat_attributes' in stix_extension['extension_properties']

        sdo_type_indicator = "indicator"
        stix_indicator = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_indicator)
        assert 'x_ibm_original_threat_feed_data' in stix_indicator
        assert 'full' in stix_indicator['x_ibm_original_threat_feed_data']
        assert 'description' in stix_indicator

    @convert_bundle_object(transmitQueryData_url)
    def test_query_url(self):
        sdo_type_identity = "identity"
        stix_identity = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_identity)
        assert 'type' in stix_identity and stix_identity['type'] == DATA_SOURCE['type']
        assert 'name' in stix_identity and stix_identity['name'] == DATA_SOURCE['name']
        assert 'identity_class' in stix_identity and stix_identity['identity_class'] == DATA_SOURCE['identity_class']
        
        sdo_type_extenseion = 'extension-definition'
        stix_extension = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, 'extension-definition')
        assert 'type' in stix_extension and stix_extension['type'] == sdo_type_extenseion
        assert 'name' in stix_extension
        assert 'version' in stix_extension
        assert 'extension_types' in stix_extension and stix_extension['extension_types'] == extension_types
        assert 'extension_properties' in stix_extension and 'threat_attributes' in stix_extension['extension_properties']

        sdo_type_indicator = "indicator"
        stix_indicator = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_indicator)
        assert 'x_ibm_original_threat_feed_data' in stix_indicator
        assert 'full' in stix_indicator['x_ibm_original_threat_feed_data']
        assert 'description' in stix_indicator

    @convert_bundle_object(transmitQueryData_md5)
    def test_query_md5(self):
        sdo_type_identity = "identity"
        stix_identity = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_identity)
        assert 'type' in stix_identity and stix_identity['type'] == DATA_SOURCE['type']
        assert 'name' in stix_identity and stix_identity['name'] == DATA_SOURCE['name']
        assert 'identity_class' in stix_identity and stix_identity['identity_class'] == DATA_SOURCE['identity_class']
        
        sdo_type_extenseion = 'extension-definition'
        stix_extension = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, 'extension-definition')
        assert 'type' in stix_extension and stix_extension['type'] == sdo_type_extenseion
        assert 'name' in stix_extension
        assert 'version' in stix_extension
        assert 'extension_types' in stix_extension and stix_extension['extension_types'] == extension_types
        assert 'extension_properties' in stix_extension and 'threat_attributes' not in stix_extension['extension_properties']

        sdo_type_indicator = "indicator"
        stix_indicator = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_indicator)
        assert 'x_ibm_original_threat_feed_data' in stix_indicator
        assert 'full' in stix_indicator['x_ibm_original_threat_feed_data']
        assert 'description' in stix_indicator
        assert 'external_references' in stix_indicator

    @convert_bundle_object(transmitQueryData_md5_notfound)
    def test_query_md5_notfound(self):
        sdo_type_identity = "identity"
        stix_identity = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_identity)
        assert 'type' in stix_identity and stix_identity['type'] == DATA_SOURCE['type']
        assert 'name' in stix_identity and stix_identity['name'] == DATA_SOURCE['name']
        assert 'identity_class' in stix_identity and stix_identity['identity_class'] == DATA_SOURCE['identity_class']
        
        sdo_type_extenseion = 'extension-definition'
        stix_extension = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, 'extension-definition')
        assert 'type' in stix_extension and stix_extension['type'] == sdo_type_extenseion
        assert 'name' in stix_extension
        assert 'version' in stix_extension
        assert 'extension_types' in stix_extension and stix_extension['extension_types'] == extension_types
        assert 'extension_properties' in stix_extension and 'threat_attributes' not in stix_extension['extension_properties']

        sdo_type_indicator = "indicator"
        stix_indicator = TestMandiantResultsToStix.get_first_of_type(self.result_bundle_objects, sdo_type_indicator)
        assert 'x_ibm_original_threat_feed_data' in stix_indicator
        assert 'full' in stix_indicator['x_ibm_original_threat_feed_data']
        assert 'description' in stix_indicator and stix_indicator['description'] == 'N/A'
        assert 'external_references' not in stix_indicator